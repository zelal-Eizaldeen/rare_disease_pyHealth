<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rare Disease Annotation Reviewer</title>
  <!-- Include Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lucide icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-icons-web/0.24.0/lucide-icons-web.min.js"></script>
  <style>
    .hidden {
      display: none;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .whitespace-pre-wrap {
      white-space: pre-wrap;
    }

    /* Added styling for disabled button to make it obvious */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="flex flex-col h-screen max-h-screen bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 shadow-md">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Rare Disease Annotation Reviewer</h1>
      <div class="flex items-center space-x-2">
        <button id="guidelines-button" class="p-2 rounded hover:bg-blue-600" title="Show Guidelines">
          <i data-lucide="book-open" class="w-5 h-5"></i>
        </button>
        <button id="info-button" class="p-2 rounded hover:bg-blue-600" title="Show Information">
          <i data-lucide="info" class="w-5 h-5"></i>
        </button>
        <div class="relative">
          <label for="file-upload" class="flex items-center p-2 rounded bg-blue-600 hover:bg-blue-500 cursor-pointer"
            title="Upload JSON file">
            <i data-lucide="upload" class="w-5 h-5 mr-1"></i>
            <span>Upload</span>
          </label>
          <input id="file-upload" type="file" accept=".json" class="hidden">
        </div>
        <button id="download-button" class="flex items-center p-2 rounded bg-green-600 hover:bg-green-500"
          title="Download corrected annotations" disabled>
          <i data-lucide="download" class="w-5 h-5 mr-1"></i>
          <span>Export</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Guidelines Modal -->
  <div id="guidelines-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">Annotation Guidelines</h2>
      <div class="space-y-3">
        <p>
          Please decide whether the following highlighted entities are rare diseases. We define rare diseases as those that affect less than 1 in 200,000 people or a disease that is defined the rare disease database Orphanet.
        </p>
        <p>
          We provide the context, existing annotated Orpha code, and potentially a candidate from Orphanet (defined by RDMA). When considering context, please make sure to check for negations and other key points of information.
        </p>
        <p>
          Please decide whether the text mentions a rare disease, yes or no.
        </p>
      </div>
      <button id="close-guidelines-modal" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
        Understood
      </button>
    </div>
  </div>

  <!-- Information Modal -->
  <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">How to Use This Tool</h2>
      <div class="space-y-3">
        <p><strong>1. Load Data:</strong> Click "Upload" to load a JSON file with flagged entities.</p>
        <p><strong>2. Review Entities:</strong> For each entity, decide if it's a rare disease by clicking Yes or No.
        </p>
        <p><strong>3. Navigate:</strong> Use the arrow buttons to move between entities.</p>
        <p><strong>4. Filter:</strong> Use the dropdown to filter by entity category.</p>
        <p><strong>5. Export:</strong> Click "Export" to download your decisions as a JSON file.</p>
      </div>
      <button id="close-info-modal" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500">
        Close
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 overflow-hidden">
    <!-- Loading State -->
    <div id="loading-state" class="h-full flex items-center justify-center hidden">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700 mx-auto"></div>
        <p class="mt-4 text-lg">Loading data...</p>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="h-full flex items-center justify-center">
      <div class="text-center max-w-md p-6 bg-white rounded-lg shadow-lg">
        <h2 class="text-xl font-bold mb-4">No Entities Loaded</h2>
        <p class="mb-6">
          Please upload a JSON file containing flagged entities for review.
          The file should contain the output from the supervisor script.
        </p>
        <label for="initial-file-upload"
          class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 cursor-pointer">
          <i data-lucide="upload" class="w-4.5 h-4.5 mr-2"></i>
          <span>Upload JSON File</span>
        </label>
        <input id="initial-file-upload" type="file" accept=".json" class="hidden">
      </div>
    </div>

    <!-- No Results State -->
    <div id="no-results-state" class="h-full flex items-center justify-center hidden">
      <div class="text-center">
        <p class="text-lg">No entities match the current filter.</p>
      </div>
    </div>

    <!-- Entity Review State -->
    <div id="entity-review-state" class="grid grid-cols-1 md:grid-cols-5 gap-4 h-full hidden">
      <!-- Left sidebar - Stats & Controls -->
      <div class="p-4 bg-white shadow-md md:col-span-1 overflow-y-auto">
        <div class="mb-6">
          <h2 class="text-lg font-bold mb-2">Statistics</h2>
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-gray-100 p-2 rounded">
              <div class="text-sm text-gray-600">Total</div>
              <div id="stats-total" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-green-100 p-2 rounded">
              <div class="text-sm text-gray-600">Reviewed</div>
              <div id="stats-reviewed" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-yellow-100 p-2 rounded">
              <div class="text-sm text-gray-600">Remaining</div>
              <div id="stats-remaining" class="text-xl font-bold">0</div>
            </div>
            <div class="bg-blue-100 p-2 rounded">
              <div class="text-sm text-gray-600">Progress</div>
              <div id="stats-progress" class="text-xl font-bold">0%</div>
            </div>
          </div>
        </div>

        <div class="mb-6">
          <h2 class="text-lg font-bold mb-2">Filters</h2>
          <div class="flex items-center mb-3">
            <i data-lucide="filter" class="w-4.5 h-4.5 mr-2 text-gray-600"></i>
            <label for="category-filter" class="block text-sm font-medium text-gray-700">
              Category
            </label>
          </div>
          <select id="category-filter" class="w-full p-2 border border-gray-300 rounded bg-white">
            <option value="all">All Categories</option>
            <option value="false_positives">False Positives</option>
            <option value="false_negatives">False Negatives</option>
            <option value="true_positives">True Positives</option>
          </select>
        </div>

        <div class="mb-6">
          <h2 class="text-lg font-bold mb-2">Navigation</h2>
          <p id="navigation-counter" class="text-sm mb-2">
            Showing entity 0 of 0
          </p>
          <div class="flex justify-between">
            <button id="prev-button" class="flex items-center p-2 border rounded hover:bg-gray-100 disabled:opacity-50"
              disabled>
              <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i>
              <span>Previous</span>
            </button>
            <button id="next-button" class="flex items-center p-2 border rounded hover:bg-gray-100 disabled:opacity-50"
              disabled>
              <span>Next</span>
              <i data-lucide="chevron-right" class="w-5 h-5 ml-1"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Main content - Entity details -->
      <div class="p-4 bg-white shadow-md md:col-span-4 overflow-y-auto">
        <div id="entity-details">
          <div class="mb-4 flex items-center justify-between">
            <h2 class="text-xl font-bold">Entity Review</h2>
            <div id="entity-category" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
              Category
            </div>
          </div>

          <!-- Entity details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-bold text-gray-700 mb-2">Basic Information</h3>
              <div class="space-y-2">
                <div>
                  <span class="text-sm text-gray-500">Entity:</span>
                  <div id="entity-name" class="font-bold text-lg"></div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">Document ID:</span>
                  <div id="entity-document-id"></div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">ORPHA Code:</span>
                  <div id="entity-orpha-code"></div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">Current Status:</span>
                  <div id="entity-current-status" class="font-medium"></div>
                </div>
              </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
              <h3 class="font-bold text-gray-700 mb-2">Top Candidate</h3>
              <div class="space-y-2">
                <div>
                  <span class="text-sm text-gray-500">Name:</span>
                  <div id="entity-top-candidate-name" class="font-medium"></div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">ID:</span>
                  <div id="entity-top-candidate-id"></div>
                </div>
                <div>
                  <span class="text-sm text-gray-500">Similarity:</span>
                  <div id="entity-top-candidate-similarity"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Context -->
          <div class="mb-6">
            <h3 class="font-bold text-gray-700 mb-2">Text Context</h3>
            <div id="entity-context" class="bg-gray-50 p-4 rounded-lg whitespace-pre-wrap"></div>
          </div>

          <!-- Explanation -->
          <div class="mb-6">
            <h3 class="font-bold text-gray-700 mb-2">Flag Reason</h3>
            <div id="entity-explanation" class="bg-gray-50 p-4 rounded-lg"></div>
          </div>

          <!-- Decision section -->
          <div class="border-t pt-4 mt-6">
            <h3 class="font-bold text-gray-700 mb-4">Your Decision</h3>

            <!-- Reviewed State -->
            <div id="reviewed-decision" class="hidden">
              <div class="flex items-center">
                <div id="review-result" class="flex items-center p-3 rounded-lg bg-gray-100">
                  <i id="review-icon" data-lucide="check" class="w-6 h-6 mr-2"></i>
                  <span id="review-text" class="font-medium"></span>
                </div>

                <div class="ml-4">
                  <button id="change-decision-button" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">
                    Change Decision
                  </button>
                </div>
              </div>
            </div>

            <!-- Unreveiwed State -->
            <div id="decision-buttons" class="flex space-x-4">
              <button id="yes-button"
                class="flex-1 flex justify-center items-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                <i data-lucide="check" class="w-6 h-6 mr-2"></i>
                <span class="font-bold">YES</span>
                <span class="ml-2">It's a rare disease</span>
              </button>

              <button id="no-button"
                class="flex-1 flex justify-center items-center px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                <i data-lucide="x" class="w-6 h-6 mr-2"></i>
                <span class="font-bold">NO</span>
                <span class="ml-2">It's not a rare disease</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-200 py-2 px-4 text-center text-gray-600 text-sm">
    <p>Rare Disease Annotation Reviewer Tool</p>
  </footer>

  <script>
    // Application state
    const state = {
      entities: [],
      filteredEntities: [],
      currentIndex: 0,
      filter: 'all',
      decisions: {}, // Store decisions here
      stats: { total: 0, reviewed: 0, remaining: 0 },
      loading: false,
      firstLoad: true // Track if this is the first file load
    };
    // Make state globally accessible for easier debugging if needed, but rely on 'state' within the script
    window.state = state;

    // DOM Elements
    const elements = {
      // States
      loadingState: document.getElementById('loading-state'),
      emptyState: document.getElementById('empty-state'),
      noResultsState: document.getElementById('no-results-state'),
      entityReviewState: document.getElementById('entity-review-state'),

      // Buttons
      infoButton: document.getElementById('info-button'),
      closeInfoButton: document.getElementById('close-info-modal'),
      guidelinesButton: document.getElementById('guidelines-button'),
      closeGuidelinesButton: document.getElementById('close-guidelines-modal'),
      downloadButton: document.getElementById('download-button'),
      prevButton: document.getElementById('prev-button'),
      nextButton: document.getElementById('next-button'),
      yesButton: document.getElementById('yes-button'),
      noButton: document.getElementById('no-button'),
      changeDecisionButton: document.getElementById('change-decision-button'),

      // Inputs
      fileUpload: document.getElementById('file-upload'),
      initialFileUpload: document.getElementById('initial-file-upload'),
      categoryFilter: document.getElementById('category-filter'),

      // Modals
      infoModal: document.getElementById('info-modal'),
      guidelinesModal: document.getElementById('guidelines-modal'),

      // Stats
      statsTotal: document.getElementById('stats-total'),
      statsReviewed: document.getElementById('stats-reviewed'),
      statsRemaining: document.getElementById('stats-remaining'),
      statsProgress: document.getElementById('stats-progress'),
      navigationCounter: document.getElementById('navigation-counter'),

      // Entity details
      entityCategory: document.getElementById('entity-category'),
      entityName: document.getElementById('entity-name'),
      entityDocumentId: document.getElementById('entity-document-id'),
      entityOrphaCode: document.getElementById('entity-orpha-code'),
      entityCurrentStatus: document.getElementById('entity-current-status'),
      entityTopCandidateName: document.getElementById('entity-top-candidate-name'),
      entityTopCandidateId: document.getElementById('entity-top-candidate-id'),
      entityTopCandidateSimilarity: document.getElementById('entity-top-candidate-similarity'),
      entityContext: document.getElementById('entity-context'),
      entityExplanation: document.getElementById('entity-explanation'),

      // Decision UI
      reviewedDecision: document.getElementById('reviewed-decision'),
      decisionButtons: document.getElementById('decision-buttons'),
      reviewResult: document.getElementById('review-result'),
      reviewIcon: document.getElementById('review-icon'),
      reviewText: document.getElementById('review-text')
    };

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }

    // --- Core Functions ---

    // Show appropriate UI state based on data
    function updateUIState() {
      const hasEntities = state.entities.length > 0;
      const hasFilteredEntities = state.filteredEntities.length > 0;

      elements.loadingState.classList.toggle('hidden', !state.loading);
      elements.emptyState.classList.toggle('hidden', state.loading || hasEntities);
      elements.entityReviewState.classList.toggle('hidden', state.loading || !hasEntities || !hasFilteredEntities);
      elements.noResultsState.classList.toggle('hidden', state.loading || !hasEntities || hasFilteredEntities);

      // Update download button state based on whether there are any decisions
      elements.downloadButton.disabled = Object.keys(state.decisions).length === 0;
    }

    // Update stats display
    function updateStats() {
      const reviewedCount = Object.keys(state.decisions).length;
      state.stats = {
        total: state.entities.length,
        reviewed: reviewedCount,
        remaining: state.entities.length - reviewedCount
      };

      elements.statsTotal.textContent = state.stats.total;
      elements.statsReviewed.textContent = state.stats.reviewed;
      elements.statsRemaining.textContent = state.stats.remaining;
      elements.statsProgress.textContent = state.stats.total
        ? Math.round((state.stats.reviewed / state.stats.total) * 100) + '%'
        : '0%';

      // Also update the download button state here
      updateDownloadButtonState();
    }

    // Update the state of the download button
    function updateDownloadButtonState() {
      const hasDecisions = Object.keys(state.decisions).length > 0;
      elements.downloadButton.disabled = !hasDecisions;
    }

    // Apply filtering and update UI
    function applyFilters() {
      if (state.entities.length) {
        state.filteredEntities = state.filter === 'all'
          ? state.entities
          : state.entities.filter(entity => entity.category === state.filter);

        // Adjust index if current index is out of bounds after filtering
        if (state.currentIndex >= state.filteredEntities.length) {
          state.currentIndex = state.filteredEntities.length > 0 ? state.filteredEntities.length - 1 : 0;
        }
        // Ensure index is not negative if filtering results in empty array
        if (state.currentIndex < 0 && state.filteredEntities.length > 0) {
          state.currentIndex = 0;
        }

        // Update navigation counter
        elements.navigationCounter.textContent = `Showing entity ${state.filteredEntities.length > 0 ? state.currentIndex + 1 : 0} of ${state.filteredEntities.length}`;

        // Update navigation buttons
        elements.prevButton.disabled = state.currentIndex <= 0 || state.filteredEntities.length <= 1;
        elements.nextButton.disabled = state.currentIndex >= state.filteredEntities.length - 1 || state.filteredEntities.length <= 1;

        // Display current entity (or empty if no results)
        displayCurrentEntity();

        // Update stats
        updateStats();
      }

      // Update UI state (handles showing no-results message)
      updateUIState();
    }

    // Generate a unique key for each entity decision
    function getEntityKey(entity) {
      if (!entity) return null;

      // Include context for uniqueness - create a context fingerprint to avoid excessively long keys
      // Using a substring to ensure decent uniqueness without massive keys
      const contextFingerprint = entity.context ? entity.context.substring(0, 100) : '';

      // Return key with context included to properly handle duplicates with different contexts
      return JSON.stringify({
        entity: entity.entity || '',
        document_id: entity.document_id || '',
        orpha_code: entity.orpha_code || '',
        context_fingerprint: contextFingerprint
      });
    }

    // Extract detailed entities from a supervisor output file structure
    function extractDetailedEntities(data) {
      const flaggedEntities = data.summary?.flagged_entities || [];
      const detailedEntities = [];

      // Track already added entity-context combinations to avoid duplicates
      const addedEntityContextPairs = new Set();

      // Process each flagged entity
      for (const summaryEntity of flaggedEntities) {
        // Find the corresponding detailed entries in the results section
        const category = summaryEntity.category;
        const docId = summaryEntity.document_id;
        const entityName = summaryEntity.entity;

        if (docId && category && entityName && data.results && data.results[category]) {
          // Find ALL matching detailed entity data (not just the first one)
          const matchingEntities = data.results[category].filter(result =>
            result.document_id === docId && result.entity === entityName
          );

          if (matchingEntities.length > 0) {
            // Process each matching entity with its unique context
            for (const detailedEntity of matchingEntities) {
              const context = detailedEntity?.context || '';

              // Create a unique key for this entity-context pair
              const entityContextKey = `${entityName}|${docId}|${context.substring(0, 50)}`;

              // Skip if we've already added this entity-context pair
              if (addedEntityContextPairs.has(entityContextKey)) {
                continue;
              }

              // Mark this entity-context pair as added
              addedEntityContextPairs.add(entityContextKey);

              // Combine summary and detailed info
              const entityInfo = {
                entity: entityName,
                document_id: docId,
                orpha_code: summaryEntity.orpha_code || detailedEntity?.orpha_id || '',
                category: category,
                explanation: summaryEntity.explanation || '',
                context: context,
                is_rare_disease: detailedEntity?.is_rare_disease || false,
                top_candidate_name: detailedEntity?.orpha_candidates?.[0]?.name || '',
                top_candidate_id: detailedEntity?.orpha_candidates?.[0]?.id || '',
                top_candidate_similarity: detailedEntity?.orpha_candidates?.[0]?.similarity || 0
              };

              detailedEntities.push(entityInfo);
            }
          } else {
            // No matching detailed entity found
            // Use the same deduplication check here too
            const entityContextKey = `${entityName}|${docId}|`;

            if (!addedEntityContextPairs.has(entityContextKey)) {
              addedEntityContextPairs.add(entityContextKey);

              const entityInfo = {
                entity: entityName,
                document_id: docId,
                orpha_code: summaryEntity.orpha_code || '',
                category: category,
                explanation: summaryEntity.explanation || '',
                context: '',
                is_rare_disease: false
              };

              detailedEntities.push(entityInfo);
            }
          }
        } else {
          // Missing essential data
          // Still deduplicate
          const entityContextKey = `${entityName || ''}|${docId || ''}|`;

          if (!addedEntityContextPairs.has(entityContextKey)) {
            addedEntityContextPairs.add(entityContextKey);

            const entityInfo = {
              entity: entityName || '',
              document_id: docId || '',
              orpha_code: summaryEntity.orpha_code || '',
              category: category || '',
              explanation: summaryEntity.explanation || '',
              context: '',
              is_rare_disease: false
            };

            detailedEntities.push(entityInfo);
          }
        }
      }

      console.log(`After deduplication: ${detailedEntities.length} unique entities extracted`);
      return detailedEntities;
    }

    // Handle file upload
    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      state.loading = true;
      // Clear previous state before loading
      state.entities = [];
      state.filteredEntities = [];
      state.currentIndex = 0;
      state.decisions = {};
      state.filter = 'all'; // Reset filter on new file
      elements.categoryFilter.value = 'all'; // Update filter dropdown
      updateUIState(); // Show loading state

      const reader = new FileReader();

      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          let extractedEntities = [];

          // Handle different possible JSON structures
          if (data.summary?.flagged_entities && data.results) {
            // Assume supervisor output file
            extractedEntities = extractDetailedEntities(data);
            console.log(`Extracted ${extractedEntities.length} entities from supervisor format.`);
          } else if (Array.isArray(data)) {
            // Assume direct array of entities (might need structure validation)
            console.warn("Uploaded file is a direct array. Ensure it matches the expected entity structure.");
            // Basic structure check: does the first item look like an entity?
            if (data.length > 0 && data[0].entity && data[0].document_id) {
              extractedEntities = data;
            } else {
              throw new Error("Uploaded array structure does not match expected entity format.");
            }
          } else {
            throw new Error('Could not find flagged entities in the uploaded file. Ensure it\'s a valid supervisor output JSON.');
          }

          if (extractedEntities.length === 0) {
            alert('No entities found in the uploaded file.');
          }

          state.entities = extractedEntities;
          state.loading = false; // Hide loading state

          // Show guidelines on first successful load
          if (state.firstLoad && extractedEntities.length > 0) {
            elements.guidelinesModal.classList.remove('hidden');
            state.firstLoad = false;
          }

          // Reset filter and apply it to populate filteredEntities and update UI
          applyFilters(); // This will call updateStats and updateUIState internally

          // For debugging - show how many entities we found with the same name but different contexts
          const entityNameCounts = {};
          state.entities.forEach(entity => {
            const name = entity.entity;
            entityNameCounts[name] = (entityNameCounts[name] || 0) + 1;
          });

          const duplicateNames = Object.entries(entityNameCounts)
            .filter(([name, count]) => count > 1)
            .map(([name, count]) => `${name} (${count})`);

          if (duplicateNames.length > 0) {
            console.log(`Found ${duplicateNames.length} entity names with multiple contexts: ${duplicateNames.join(', ')}`);
          }

        } catch (error) {
          console.error('Error loading or parsing file:', error);
          alert('Error loading file: ' + error.message);
          state.loading = false;
          state.entities = []; // Clear state on error
          state.filteredEntities = [];
          state.currentIndex = 0;
          state.decisions = {};
          applyFilters(); // Reset UI to empty state
        } finally {
          // Clear the file input value so the same file can be re-uploaded
          event.target.value = null;
        }
      };

      reader.onerror = () => {
        alert('Error reading file');
        console.error('FileReader error:', reader.error);
        state.loading = false;
        state.entities = []; // Clear state on error
        state.filteredEntities = [];
        state.currentIndex = 0;
        state.decisions = {};
        applyFilters(); // Reset UI to empty state
        // Clear the file input value
        event.target.value = null;
      };

      reader.readAsText(file);
    }

    // Display the current entity
    function displayCurrentEntity() {
      if (state.filteredEntities.length === 0) {
        // Clear displayed details if no entities match filter
        elements.entityCategory.textContent = 'N/A';
        elements.entityCategory.className = `px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800`;
        elements.entityName.textContent = 'N/A';
        elements.entityDocumentId.textContent = 'N/A';
        elements.entityOrphaCode.textContent = 'N/A';
        elements.entityCurrentStatus.textContent = 'N/A';
        elements.entityTopCandidateName.textContent = 'N/A';
        elements.entityTopCandidateId.textContent = 'N/A';
        elements.entityTopCandidateSimilarity.textContent = 'N/A';
        elements.entityContext.innerHTML = '<span class="text-gray-500 italic">No context available</span>';
        elements.entityExplanation.textContent = 'N/A';

        // Hide decision UI
        elements.reviewedDecision.classList.add('hidden');
        elements.decisionButtons.classList.add('hidden');

        return; // Stop here if no entities
      }

      const currentEntity = state.filteredEntities[state.currentIndex];
      if (!currentEntity) {
        console.error("Attempted to display entity at invalid index:", state.currentIndex, state.filteredEntities);
        // Attempt to recover by going to the first entity if possible
        if (state.filteredEntities.length > 0) {
          state.currentIndex = 0;
          displayCurrentEntity(); // Try again with index 0
        }
        return;
      }

      // Update category badge
      elements.entityCategory.textContent = currentEntity.category?.replace('_', ' ') || 'Category';
      elements.entityCategory.className = `px-3 py-1 rounded-full text-sm font-medium ${currentEntity.category === 'false_positives' ? 'bg-orange-100 text-orange-800' :
        currentEntity.category === 'false_negatives' ? 'bg-purple-100 text-purple-800' :
          'bg-blue-100 text-blue-800' // Assuming true_positives or others
        }`;

      // Basic information
      elements.entityName.textContent = currentEntity.entity || '';
      elements.entityDocumentId.textContent = currentEntity.document_id || '';
      elements.entityOrphaCode.textContent = currentEntity.orpha_code || 'N/A'; // Show N/A if empty
      elements.entityCurrentStatus.textContent = (currentEntity.is_rare_disease !== undefined)
        ? (currentEntity.is_rare_disease ? "Marked as rare disease (Initial)" : "Not marked as rare disease (Initial)")
        : "Status Unknown";

      // Top candidate
      elements.entityTopCandidateName.textContent = currentEntity.top_candidate_name || "N/A";
      elements.entityTopCandidateId.textContent = currentEntity.top_candidate_id || "N/A";
      elements.entityTopCandidateSimilarity.textContent = (currentEntity.top_candidate_similarity !== undefined && currentEntity.top_candidate_similarity !== null)
        ? `${(currentEntity.top_candidate_similarity * 100).toFixed(1)}%`
        : "N/A";


      // Context with highlighting
      const contextDiv = elements.entityContext;
      const entityName = currentEntity.entity || '';
      const contextText = currentEntity.context || '';

      if (contextText && entityName) {
        contextDiv.innerHTML = ''; // Clear existing content
        const parts = contextText.split(new RegExp(`(${entityName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi')); // Case-insensitive split, handle special chars
        parts.forEach((part, index) => {
          if (part.toLowerCase() === entityName.toLowerCase()) { // Check case-insensitively
            const highlightSpan = document.createElement('span');
            highlightSpan.className = 'bg-yellow-200 font-bold';
            highlightSpan.textContent = part; // Keep original casing from text
            contextDiv.appendChild(highlightSpan);
          } else {
            contextDiv.appendChild(document.createTextNode(part));
          }
        });
      } else if (contextText) {
        contextDiv.textContent = contextText; // Just display context if no entity name to highlight
      }
      else {
        contextDiv.innerHTML = '<span class="text-gray-500 italic">No context available</span>';
      }


      // Explanation
      elements.entityExplanation.textContent = currentEntity.explanation || "No explanation provided";

      // Check if this entity has been reviewed using the robust key
      const entityKey = getEntityKey(currentEntity);
      const decision = state.decisions[entityKey];
      const hasBeenReviewed = !!decision;

      // Show appropriate decision UI
      if (hasBeenReviewed) {
        const reviewDecision = decision.is_rare_disease;

        // Update review result display
        elements.reviewResult.className = `flex items-center p-3 rounded-lg ${reviewDecision ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
          }`;

        // Update review icon
        elements.reviewIcon.setAttribute('data-lucide', reviewDecision ? 'check' : 'x');
        // Re-create icon dynamically
        if (typeof lucide !== 'undefined') {
          lucide.createIcons({ attrs: { width: 24, height: 24, class: 'mr-2' }, container: elements.reviewResult });
        }


        // Update review text
        elements.reviewText.textContent = `You marked this as ${reviewDecision ? 'a rare disease' : 'NOT a rare disease'}`;

        // Show reviewed state, hide decision buttons
        elements.reviewedDecision.classList.remove('hidden');
        elements.decisionButtons.classList.add('hidden');
      } else {
        // Show decision buttons, hide reviewed state
        elements.reviewedDecision.classList.add('hidden');
        elements.decisionButtons.classList.remove('hidden');
      }
    }

    // Handle decision making (yes/no)
    // Modified to accept a second parameter indicating whether to navigate after decision
    function makeDecision(isRareDisease, navigateAfter = true) {
      const currentEntity = state.filteredEntities[state.currentIndex];
      if (!currentEntity) {
        console.error("Cannot make decision, no current entity.");
        return;
      }

      const entityKey = getEntityKey(currentEntity);
      if (!entityKey) {
        console.error("Cannot make decision, failed to generate entity key.");
        return;
      }

      // Store/update decision in state.decisions using the unique key
      state.decisions[entityKey] = {
        entity: currentEntity.entity,
        document_id: currentEntity.document_id,
        orpha_code: currentEntity.orpha_code,
        category: currentEntity.category,
        is_rare_disease: isRareDisease,
        decision_timestamp: new Date().toISOString(),
        // Store context to preserve it in the export
        context: currentEntity.context || ''
      };

      // Update UI and state
      displayCurrentEntity(); // Update current view to show reviewed state
      updateStats(); // Update stats counts and download button state

      // Only navigate if the navigateAfter parameter is true
      if (navigateAfter) {
        // Move to next entity if available and not the last one
        if (state.filteredEntities.length > 0 && state.currentIndex < state.filteredEntities.length - 1) {
          goToNext();
        } else if (state.filteredEntities.length > 0 && state.currentIndex === state.filteredEntities.length - 1) {
          // If it's the last one, just ensure navigation is disabled
          elements.nextButton.disabled = true;
        }
      }
    }

    // Navigation functions
    function goToPrevious() {
      if (state.currentIndex > 0) {
        state.currentIndex -= 1;
        displayCurrentEntity();
        // Update button states directly after changing index
        elements.prevButton.disabled = state.currentIndex <= 0;
        elements.nextButton.disabled = state.currentIndex >= state.filteredEntities.length - 1;
        elements.navigationCounter.textContent = `Showing entity ${state.currentIndex + 1} of ${state.filteredEntities.length}`;
      }
    }

    function goToNext() {
      if (state.filteredEntities.length > 0 && state.currentIndex < state.filteredEntities.length - 1) {
        state.currentIndex += 1;
        displayCurrentEntity();
        // Update button states directly after changing index
        elements.prevButton.disabled = state.currentIndex <= 0;
        elements.nextButton.disabled = state.currentIndex >= state.filteredEntities.length - 1;
        elements.navigationCounter.textContent = `Showing entity ${state.currentIndex + 1} of ${state.filteredEntities.length}`;
      }
    }

    // Handle download of corrected annotations
    function downloadCorrectedAnnotations() {
      console.log("Attempting to download corrected annotations...");

      const decisions = state.decisions || {};
      const decisionCount = Object.keys(decisions).length;

      if (decisionCount === 0) {
        alert('No annotations have been reviewed yet. Please review at least one entity before exporting.');
        console.warn("Download attempted with no decisions.");
        return;
      }

      try {
        // Prepare export data
        const output = {
          metadata: {
            timestamp: new Date().toISOString(),
            total_entities_in_file: state.entities.length,
            reviewed_entities: decisionCount
          },
          corrected_annotations: Object.values(decisions)
        };

        // Convert to JSON with pretty formatting
        const jsonData = JSON.stringify(output, null, 2);

        // Create a Blob
        const blob = new Blob([jsonData], { type: 'application/json' });

        // Create a temporary URL for the blob
        const url = URL.createObjectURL(blob);

        // Create a temporary link element
        const link = document.createElement('a');
        link.href = url;
        link.download = 'rare_disease_reviews.json'; // Set desired file name
        link.style.display = 'none'; // Hide the link

        // Append the link to the body, click it, and remove it
        document.body.appendChild(link);
        link.click();

        // Clean up the temporary URL and link
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          console.log("Download initiated successfully.");
        }, 100); // Small delay to ensure click registers


      } catch (error) {
        console.error("Export error:", error);
        alert(`Failed to export annotations: ${error.message}\n\nPlease try again or check the console for details.`);
      }
    }

    // --- Event Listeners ---

    // Use DOMContentLoaded to ensure elements exist before attaching listeners
    document.addEventListener('DOMContentLoaded', () => {

      // Initialize UI state (shows empty state initially)
      updateUIState();
      updateDownloadButtonState(); // Set initial download button state

      // Info modal
      elements.infoButton.addEventListener('click', () => {
        elements.infoModal.classList.remove('hidden');
      });
      elements.closeInfoButton.addEventListener('click', () => {
        elements.infoModal.classList.add('hidden');
      });
      // Close modal if clicked outside
      elements.infoModal.addEventListener('click', (e) => {
        if (e.target === elements.infoModal) {
          elements.infoModal.classList.add('hidden');
        }
      });

      // Guidelines modal
      elements.guidelinesButton.addEventListener('click', () => {
        elements.guidelinesModal.classList.remove('hidden');
      });
      elements.closeGuidelinesButton.addEventListener('click', () => {
        elements.guidelinesModal.classList.add('hidden');
      });
      // Close modal if clicked outside
      elements.guidelinesModal.addEventListener('click', (e) => {
        if (e.target === elements.guidelinesModal) {
          elements.guidelinesModal.classList.add('hidden');
        }
      });

      // File Upload
      elements.fileUpload.addEventListener('change', handleFileUpload);
      elements.initialFileUpload.addEventListener('change', handleFileUpload); // Listener for the empty state upload

      // Filter
      elements.categoryFilter.addEventListener('change', (e) => {
        state.filter = e.target.value;
        applyFilters();
      });

      // Navigation
      elements.prevButton.addEventListener('click', goToPrevious);
      elements.nextButton.addEventListener('click', goToNext);

      // Decision Buttons - modified to include the navigateAfter parameter
      elements.yesButton.addEventListener('click', () => makeDecision(true, true)); // Navigate after
      elements.noButton.addEventListener('click', () => makeDecision(false, true)); // Navigate after
      elements.changeDecisionButton.addEventListener('click', () => {
        const currentEntity = state.filteredEntities[state.currentIndex];
        if (!currentEntity) return; // Should not happen if button is visible

        const entityKey = getEntityKey(currentEntity);
        const currentDecision = state.decisions[entityKey]?.is_rare_disease; // Get the current stored decision

        // Toggle decision: if it was true, make it false; if false or undefined, make it true
        makeDecision(!currentDecision, false); // Don't navigate after changing the decision
      });

      // Download Button
      elements.downloadButton.addEventListener('click', downloadCorrectedAnnotations);

      // Initial update of navigation buttons and stats
      applyFilters(); // This calls updateStats and displayCurrentEntity
    });
  </script>
</body>

</html>